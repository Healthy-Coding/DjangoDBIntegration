{% extends 'base.html' %}
{% block title %} {{ page_name }} {% endblock title %}

{% load static %}

{% block content %}
<div class="container-fluid">
    <!-- Link to flag this page -->
    <div class="row">
        <div class="col-md-11 text-right">
            <a href="{% url 'Colleges:flag_page' id %}" class="btn btn-link">See something wrong with this page? Let us know!<span class="glyphicon glyphicon-flag"></span></a>
        </div>
    </div>

    <!-- College name and picture -->
    <div class="row">
        <div class="col-md-5 col-md-offset-1">
            <h1><u>{{page_name}}</u></h1>
            <h2><small>{{city}},{{state}}</small></h2>
            <h4 class="todo">TODO: Maybe add more school information here? Would need to scrape it from the html</h4>
            <h4 class="todo">TODO: data about the clubs/services available?</h4>
        </div>
        <div class="col-md-3 col-md-offset-2 text-right">
            <img src="{{ college_pictures.url }}" class="img-responsive">
        </div>
    </div>

    <!-- Demographic information -->
    <div class="row">
        <div class="col-md-10 col-md-offset-1">
            <hr style="border-top: 1px solid #8c8b8b;">
            <h4>Demographic Information</h4>
            <hr style="border-top: 1px solid #8c8b8b;">
        </div>
    </div>

    <div class="row">
        <div class="col-md-10 col-md-offset-1">
            <table id="diversity" class="tablesorter table table-condensed table-bordered">
                <thead>
                <tr>
                    {% for header in headers %}
                        <th>{{ header }}</th>
                    {% endfor %}
                </tr>
                </thead>
                <tbody>
                {% for key, values in data.items %}
                    <tr>
                        <td>{{key}}</td>
                        {% for value in values %}
                            <td> {{value}} </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="row">
        <div class="col-md-10 col-md-offset-1">
            <div id="chart_div"></div>
        </div>
    </div>

    <!-- Financial Information -->
    <div class="row">
        <div class="col-md-10 col-md-offset-1">
            <hr style="border-top: 1px solid #8c8b8b;">
            <h4>Financial Information</h4>
            <hr style="border-top: 1px solid #8c8b8b;">
        </div>
    </div>

    <div class="row">
        <div class="col-md-5 col-md-offset-1">
            <table id="dollars" class="tablesorter table table-condensed table-bordered">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value (in dollars)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in dollars.items %}
                        <tr>
                            <td>{{key}}</td>
                            <td>{{value}}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="col-md-5">
            <table class="tablesorter table table-condensed table-bordered">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value (in percent)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in percent.items %}
                        <tr>
                            <td>{{key}}</td>
                            <td>{{value}}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <h4 class="todo">TODO: Is there more financial information we can add? Maybe database wide averages</h4>
        <div id="box_plot"></div>

    <h4 class="todo">TODO: Page last modified -- this needs to also end up in the database</h4>
        <div id="box_plot"></div>
</div>
{% endblock content %}

{% block footer_javascript_section %}
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
  // Load the Visualization API and the corechart package.
  google.charts.load('current', {'packages':['corechart']});

  // Set a callback to run when the Google Visualization API is loaded.
  google.charts.setOnLoadCallback(drawVisualization);

  // Callback that creates and populates a data table,
  // instantiates the pie chart, passes in the data and
  // draws it.
  function drawVisualization() {

    // Create the data table.

    var djangoData = {{ google_graph|safe }};
    var data = google.visualization.arrayToDataTable(djangoData);

    // Set chart options
    var options = {
      title : 'Demographics by Source Compared to State',
      seriesType: 'bars',
      series: {4: {type: 'line'}},
      height: 500
    };

    // Instantiate and draw our chart, passing in some options.
    var chart = new google.visualization.ComboChart(document.getElementById('chart_div'));
    chart.draw(data, options);
  }
</script>



<script src="{% static 'assets/js/jquery.tablesorter.min.js' %}"></script>
<script>
    $(document).ready(function()
        {
            $("#diversity").tablesorter();
            $("#dollars").tablesorter();
        });
</script>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">

      google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(drawBoxPlot);

    function drawBoxPlot() {

      var array = [
        {{ IncomeList1|safe }},
        {{ IncomeList2|safe }},
        {{ IncomeList3|safe }},
        {{ IncomeList4|safe }},
        {{ IncomeList5|safe }},
      ];

      var data = new google.visualization.DataTable();
      data.addColumn('string', 'x');
      data.addColumn('number', 'Income Bracket1');
      data.addColumn('number', 'Income Bracket2');
      data.addColumn('number', 'Income Bracket3');
      data.addColumn('number', 'Income Bracket4');
      data.addColumn('number', 'Income Bracket5');

      data.addColumn({id:'max', type:'number', role:'interval'});
      data.addColumn({id:'min', type:'number', role:'interval'});
      data.addColumn({id:'firstQuartile', type:'number', role:'interval'});
      data.addColumn({id:'median', type:'number', role:'interval'});
      data.addColumn({id:'thirdQuartile', type:'number', role:'interval'});
      data.addColumn({id:'specific', type:'number', role:'interval'});

      data.addRows(getBoxPlotValues(array));

      /**
       * Takes an array of input data and returns an
       * array of the input data with the box plot
       * interval data appended to each row.
       */
      function getBoxPlotValues(array) {

        for (var i = 0; i < array.length; i++) {

          var arr = array[i].slice(1).sort(function (a, b) {
            return a - b;
          });

          var max = arr[arr.length - 1];
          var min = arr[0];
          var median = arr[3];

          // First Quartile is the median from lowest to overall median.
          var firstQuartile = getMedian(arr.slice(0, median));

          // Third Quartile is the median from the overall median to the highest.
          var thirdQuartile = getMedian(arr.slice(3));
          var college_specific = {{ college_specs|safe }};
          array[i][6] = max;
          array[i][7] = min
          array[i][8] = firstQuartile;
          array[i][9] = median;
          array[i][10] = thirdQuartile;
          array[i][11] = college_specific[i];
        }
        return array;
      }

      /*
       * Takes an array and returns
       * the median value.
       */
      function getMedian(array) {
        var length = array.length;

        /* If the array is an even length the
         * median is the average of the two
         * middle-most values. Otherwise the
         * median is the middle-most value.
         */
        if (length % 2 === 0) {
          var midUpper = length / 2;
          var midLower = midUpper - 1;

          return (array[midUpper] + array[midLower]) / 2;
        } else {
          return array[Math.floor(length / 2)];
        }
      }

      var options = {
          title:'Relative Cost Per Income Bracket',
          height: 500,
          hAxis: {
            gridlines: {color: '#fff'}
          },
          lineWidth: 0,
          series: [{'color': '#D3362D'}],
          intervals: {
            barWidth: 1,
            boxWidth: 1,
            lineWidth: 2,
            style: 'boxes'
          },
          interval: {
            max: {
              style: 'bars',
              fillOpacity: 1,
              color: '#777'
            },
            min: {
              style: 'bars',
              fillOpacity: 1,
              color: '#777'
            },
              specific: {
              style: 'points',
              fillOpacity: 1,
              color: '#FF0000'
            },
          }
      };

      var chart = new google.visualization.LineChart(document.getElementById('box_plot'));

      chart.draw(data, options);
    }



</script>

{% endblock footer_javascript_section %}
